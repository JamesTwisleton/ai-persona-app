"""
Test User Model

Following TDD: These tests were written BEFORE implementing the User model!

TDD Cycle Completed:
✅ RED: Tests written first and failed initially
✅ GREEN: User model implemented - all tests now PASS!
✅ REFACTOR: Can now improve code while keeping tests green

Test Coverage:
- User model creation and attributes
- Email validation and uniqueness constraint
- Password hashing (not storing plain text passwords)
- Timestamp fields (created_at, updated_at)
- User representation (__repr__)
"""

import pytest
from datetime import datetime
from sqlalchemy.exc import IntegrityError


@pytest.mark.unit
class TestUserModel:
    """Test the User database model"""

    def test_user_model_exists(self):
        """
        GREEN: This test now PASSES!

        Requirement: User model should be importable
        """
        from app.models.user import User
        assert User is not None

    def test_create_user_with_required_fields(self, db_session):
        """
        GREEN: This test now PASSES!

        Requirement: User should be creatable with email and password_hash
        """
        from app.models.user import User

        user = User(
            email="test@example.com",
            password_hash="hashed_password_here"
        )

        db_session.add(user)
        db_session.commit()
        db_session.refresh(user)

        assert user.id is not None
        assert user.email == "test@example.com"
        assert user.password_hash == "hashed_password_here"

    def test_user_email_is_required(self, db_session):
        """
        RED: This test will fail.

        Requirement: Email field should be required (NOT NULL)
        """
        from app.models.user import User

        user = User(password_hash="hashed_password")

        db_session.add(user)

        with pytest.raises(IntegrityError):
            db_session.commit()

    def test_user_password_hash_is_required(self, db_session):
        """
        RED: This test will fail.

        Requirement: Password hash field should be required
        """
        from app.models.user import User

        user = User(email="test@example.com")

        db_session.add(user)

        with pytest.raises(IntegrityError):
            db_session.commit()

    def test_user_email_must_be_unique(self, db_session):
        """
        RED: This test will fail.

        Requirement: Email should have UNIQUE constraint
        """
        from app.models.user import User

        # Create first user
        user1 = User(
            email="duplicate@example.com",
            password_hash="hash1"
        )
        db_session.add(user1)
        db_session.commit()

        # Attempt to create second user with same email
        user2 = User(
            email="duplicate@example.com",
            password_hash="hash2"
        )
        db_session.add(user2)

        with pytest.raises(IntegrityError):
            db_session.commit()

    def test_user_has_created_at_timestamp(self, db_session):
        """
        RED: This test will fail.

        Requirement: User should have created_at timestamp
        """
        from app.models.user import User

        user = User(
            email="timestamp@example.com",
            password_hash="hash"
        )

        db_session.add(user)
        db_session.commit()
        db_session.refresh(user)

        assert hasattr(user, 'created_at')
        assert isinstance(user.created_at, datetime)
        assert user.created_at is not None

    def test_user_has_updated_at_timestamp(self, db_session):
        """
        RED: This test will fail.

        Requirement: User should have updated_at timestamp
        """
        from app.models.user import User

        user = User(
            email="timestamp2@example.com",
            password_hash="hash"
        )

        db_session.add(user)
        db_session.commit()
        db_session.refresh(user)

        assert hasattr(user, 'updated_at')
        assert isinstance(user.updated_at, datetime)
        assert user.updated_at is not None

    def test_user_updated_at_changes_on_modification(self, db_session):
        """
        RED: This test will fail.

        Requirement: updated_at should auto-update on modification
        """
        from app.models.user import User
        import time

        # Create user
        user = User(
            email="update@example.com",
            password_hash="hash1"
        )
        db_session.add(user)
        db_session.commit()
        db_session.refresh(user)

        original_updated_at = user.updated_at

        # Wait a moment then update
        time.sleep(0.1)
        user.password_hash = "hash2"
        db_session.commit()
        db_session.refresh(user)

        assert user.updated_at > original_updated_at

    def test_user_repr(self, db_session):
        """
        RED: This test will fail.

        Requirement: User should have readable string representation
        """
        from app.models.user import User

        user = User(
            email="repr@example.com",
            password_hash="hash"
        )

        db_session.add(user)
        db_session.commit()
        db_session.refresh(user)

        repr_str = repr(user)
        assert "User" in repr_str
        assert "repr@example.com" in repr_str

    def test_user_email_is_case_insensitive(self, db_session):
        """
        RED: This test will fail.

        Requirement: Email should be stored in lowercase for consistency
        """
        from app.models.user import User

        user = User(
            email="Test@EXAMPLE.com",
            password_hash="hash"
        )

        db_session.add(user)
        db_session.commit()
        db_session.refresh(user)

        # Email should be normalized to lowercase
        assert user.email == "test@example.com"

    def test_user_cannot_store_plain_password(self):
        """
        Requirement: User model should NOT have a 'password' field.
        Only password_hash should exist for security.
        """
        from app.models.user import User

        user = User(email="test@example.com", password_hash="hash")

        # Should not have a plain password field
        assert not hasattr(user, 'password')

    def test_user_id_is_auto_incremented(self, db_session):
        """
        RED: This test will fail.

        Requirement: User ID should be auto-generated (primary key, autoincrement)
        """
        from app.models.user import User

        user1 = User(email="user1@example.com", password_hash="hash1")
        user2 = User(email="user2@example.com", password_hash="hash2")

        db_session.add(user1)
        db_session.add(user2)
        db_session.commit()
        db_session.refresh(user1)
        db_session.refresh(user2)

        assert user1.id is not None
        assert user2.id is not None
        assert user2.id > user1.id  # Auto-increment


# ============================================================================
# TDD Status: GREEN Phase ✅
# ============================================================================
#
# Running `pytest tests/unit/test_user_model.py -v`
# shows ALL tests PASSING (12 passed)!
#
# TDD Cycle Complete:
# ✅ RED: Tests written first (failed initially)
# ✅ GREEN: User model implemented (tests now pass)
# ✅ REFACTOR: Can now improve code while keeping tests green
#
# Next: Continue Phase 2 with password hashing and authentication
# ============================================================================
